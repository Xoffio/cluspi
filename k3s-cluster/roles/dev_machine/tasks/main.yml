- name: Ensure ~/.kube exists locally
  ansible.builtin.file:
    path: "{{ lookup('env','HOME') }}/.kube"
    state: directory
    mode: "0700"

- name: Fetch kubeconfig from main control
  ansible.builtin.fetch:
    src: "/etc/rancher/k3s/k3s.yaml"
    dest: "{{ lookup('env','HOME') }}/.kube/config"
    flat: true
  run_once: true
  delegate_to: "{{ control_host }}"

- name: Point kubeconfig server to the LB VIP
  replace:
    path: "{{ lookup('env','HOME') }}/.kube/config"
    regexp: 'server:\s*https?://127\.0\.0\.1(:\d+)'
    replace: 'server: https://{{ control_lb_virtual_ip }}\1'
    backup: true

# ---- Install kubectl ----
- name: Check if kubectl is already installed
  ansible.builtin.command: which kubectl
  register: kubectl_binary
  ignore_errors: true

- name: Download kubectl binary
  get_url:
    url: "https://dl.k8s.io/release/v1.34.1/bin/linux/amd64/kubectl"
    dest: "/tmp/kubectl"
    mode: "0644"
    force: true
  when: kubectl_binary.rc != 0

- name: Ensure ~/.local/bin exists
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/.local/bin"
    state: directory
    mode: "0755"
  when: kubectl_binary.rc != 0

- name: Move kubectl and make it executable
  ansible.builtin.copy:
    src: /tmp/kubectl          # adjust if elsewhere
    dest: "{{ ansible_env.HOME }}/.local/bin/kubectl"
    mode: "0755"
    remote_src: true
  when: kubectl_binary.rc != 0

# ---- Install Helm ----
- name: Check if Helm is already installed
  ansible.builtin.command: which helm
  register: helm_binary
  ignore_errors: true

- name: Download Helm tarball
  ansible.builtin.get_url:
    url: "https://get.helm.sh/helm-v{{ helm_ver }}-linux-amd64.tar.gz"
    dest: "/tmp/helm-v{{ helm_ver }}-linux-amd64.tar.gz"
  when: helm_binary.rc != 0

- name: Extract Helm tarball
  ansible.builtin.unarchive:
    src: /tmp/helm-v{{ helm_ver }}-linux-amd64.tar.gz
    dest: /tmp/
    remote_src: true
  when: helm_binary.rc != 0

- name: Install Helm binary
  ansible.builtin.copy:
    src: /tmp/linux-amd64/helm
    dest: "{{ ansible_env.HOME }}/.local/bin/helm"
    mode: '0755'
    remote_src: true
  when: helm_binary.rc != 0
